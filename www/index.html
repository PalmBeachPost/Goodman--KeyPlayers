<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>John Goodman case dataviz</title>
    <style>
        #loading{
            width:100%;
            height:100%;
        }
        svg{
            background:grey;
        }
        #infobox{
            height:100px;
        }
        .link {
            stroke: #000;
            stroke-width: 1px;
            fill:none;
        }

        .node {
            cursor: move;
            fill: #ccc;
            stroke: #000;
            stroke-width: 1.5px;
        }
        .node.fixed {
                border: 1px solid red;
         }
        .linklabel{
            display:none;
        }
    </style>
</head>
<body>
    <div id="loading">LOADING... Please wait</div>
    <svg id="viz"></svg>
    <div id="infobox"></div>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>

var width = 1000,
    height = 480;

var force = d3.layout.force()
    .size([width, height])
    .charge(-1000)
    .linkDistance(50)
    .on("tick", tick);

var drag = force.drag()
    .on("dragstart", dragstart);

var svg = d3.select("#viz")
    .attr("width", width)
    .attr("height", height);

var link = svg.selectAll(".link"),
    node = svg.selectAll(".node");

d3.json("./data/datafile.json", function(error, graph) {

    for (var i = 0; i < graph.links.length; i++) {
        var src = graph.links[i].source;
        var target = graph.links[i].target;
        if (graph.nodes[src].linklist == undefined) {
            graph.nodes[src].linklist = [];
        }
        graph.nodes[src].linklist[graph.nodes[src].linklist.length] = i;
        if (graph.nodes[target].linklist == undefined) {
            graph.nodes[target].linklist = [];
        }
        graph.nodes[target].linklist[graph.nodes[target].linklist.length] = i;
    }

    force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

  link = link.data(graph.links)
    .enter().append("path")
      .attr("class", "link");

  node = node.data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
      .on("mouseover", showDeets)
      .on("dblclick", dblclick)
      .call(drag);

  node.append("image")
        .attr("xlink:href", function (d) { return d.img; })
        .attr("x", -8)
        .attr("y", -8)
        .attr("width", 60)
        .attr("height", 60);

  linktext = svg.selectAll("g.linklabel")
    .data(graph.links)
  .enter().append("text")
    .attr("class", fordebug)
    .attr("dx", 1)
    .attr("dy", ".35em")
    .text(function (d) { return d.type; });

  d3.select('#loading')
    .remove();
    
});


function tick() {
    //line
    //link.attr("x1", function (d) { return d.source.x; })
    //    .attr("y1", function (d) { return d.source.y; })
    //    .attr("x2", function (d) { return d.target.x; })
    //    .attr("y2", function (d) { return d.target.y; })
    //    .attr("class", function (d) { return 'link from-' + d.source.index + ' to-' + d.target.index; });

    //arc
  link.attr("d", function (d) {
      var dx = d.target.x - d.source.x,
      dy = d.target.y - d.source.y,
      dr = Math.sqrt(dx * dx + dy * dy);
      return "M" + d.source.x + "," + d.source.y + "A" + dr + ","
          + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
  }).attr("class", function (d) { return 'link from-' + d.source.index + ' to-' + d.target.index; });


  node.attr("transform", function (d) { return "translate(" + (d.x - 30) + "," + (d.y - 30) + ")"; });

  linktext.attr("transform", function (d) {
      return "translate(" + (2*d.source.x + d.target.x) / 3 + ","
      + (5*d.source.y + d.target.y) / 6 + ")";
  });
}

function dblclick(d) {
  d3.select(this).classed("fixed", d.fixed = false);
}

function dragstart(d) {
  d3.select(this).classed("fixed", d.fixed = true);
}

function showDeets(d) {
    //show only pertinent labels
    d3.selectAll('.linklabel').style('display', 'none');
    d3.selectAll('.linklabel.from-' + d.index).style('display', 'block');
    d3.selectAll('.linklabel.to-' + d.index).style('display', 'block');

    //highlight links

    d3.select('#infobox').html(d.name + '</br>' + d.descr);
}

function fordebug(d) {
    return 'linklabel ' + 'from-' + d.source.index + ' to-' + d.target.index;
}
 </script>
</body>
</html>
